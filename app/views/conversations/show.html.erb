<div class="wrapper">
  <div class="container">
    <h2 class="inbox-title text-center">Inbox</h2>
    <div class="inbox">
      <div class="conversations">
        <ul class="list-group">
          <% @conversations.each do |conversation| %>
            <% unread_messages = conversation.messages.reject { |message| message.read || message.user_id == current_user.id }.count %>
            <% if conversation.sender_id == current_user.id || conversation.recipient_id == current_user.id %>
              <% if conversation.sender_id == current_user.id %>
                <% recipient = User.find(conversation.recipient_id) %>
              <% else %>
                <% recipient = User.find(conversation.sender_id) %>
              <% end %>
              <%= render 'card_inbox_show', recipient: recipient, unread_messages: unread_messages, conversation: conversation %>
            <% end %>
          <% end %>
        </ul>
      </div>
      <div class="messages">
        <% @messages.each_with_index do |message, index| %>
          <% if message.body %>
            <% user = User.find(message.user_id) %>
            <% if user == current_user %>
              <div class="message-div" style="margin-left: 200px;">
                <div class="message-right">
                  <p class="message-sender text-right">
                    <%= message.body %>
                  </p>
                </div>
              </div>
            <% else %>
              <div class="message-div" style="margin-right: 200px;">
                <div class="message-left">
                  <p class="message-receiver text-left">
                    <%= message.body %>
                  </p>
                </div>
              </div>
            <% end %>
          <% end %>
        <% end %>
        <div class="form-div">
          <%= form_for [@conversation, @message], html: { class: "ui reply form" } do |f| %>
            <%= f.text_area :body, class:"form-control" %>
            <%= f.text_field :user_id, value: current_user.id, type: "hidden" %>
            <%= button_tag(type: 'submit', class: "btn btn-homepage-small") do %>
              Send <i class="fab fa-telegram-plane"></i>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <h2 class="inbox-title text-center">All Users</h2>
    <ul class="list-group">
      <% @users.each do |user| %>
        <% if user.id != current_user.id %>
          <%= render 'card_user', user: user, sender_id: current_user.id, recipient_id: user.id %>
        <% end %>
      <% end %>
    </ul>
  </div>
</div>
